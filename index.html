<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>大会受付 - Start.gg / SheetToREST</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- html5-qrcode CDN -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #f5f5f5;
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px 12px 40px;
    }

    header {
      padding: 8px 0 12px;
      border-bottom: 1px solid #333;
      margin-bottom: 12px;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
    }

    header p {
      margin: 2px 0 0;
      font-size: 0.8rem;
      color: #aaa;
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (min-width: 768px) {
      .layout {
        flex-direction: row;
        align-items: flex-start;
      }
      .left, .right {
        flex: 1;
      }
    }

    .card {
      border-radius: 12px;
      padding: 12px;
      background: #1c1c1c;
      border: 1px solid #333;
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 1rem;
      border-left: 4px solid #666;
      padding-left: 6px;
    }

    #qr-reader {
      width: 100%;
      min-height: 260px;
    }

    .status {
      margin-top: 6px;
      font-size: 0.85rem;
      color: #ccc;
    }

    .field-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    .field-label {
      color: #aaa;
      min-width: 5em;
    }

    .field-value {
      flex: 1;
      font-weight: 500;
      text-align: right;
      word-break: break-all;
    }

    .highlight {
      font-size: 1.1rem;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid #666;
      margin-left: 4px;
    }

    .payment-panel {
      margin-top: 8px;
      padding: 8px;
      border-radius: 10px;
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    .payment-red {
      background: #3b1111;
      color: #ffbbbb;
    }

    .payment-green {
      background: #10311b;
      color: #b6ffd1;
    }

    .payment-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .payment-row strong {
      font-size: 1.1rem;
    }

    .select-row {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.9rem;
    }

    label {
      font-size: 0.85rem;
      color: #ccc;
    }

    select, input, textarea, button {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #444;
      padding: 6px 8px;
      font-size: 0.9rem;
      background: #111;
      color: #f5f5f5;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    button {
      cursor: pointer;
      font-weight: 600;
      background: linear-gradient(135deg, #1f8bff, #27c0ff);
      border: none;
      margin-top: 10px;
    }

    button:disabled {
      background: #555;
      cursor: not-allowed;
    }

    .small {
      font-size: 0.8rem;
      color: #aaa;
    }

    .danger-text {
      color: #ff8080;
    }

    .success-text {
      color: #6bffb2;
    }

    .log {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #aaa;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 180px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>大会受付システム（Start.gg / SheetToREST）</h1>
      <p>QRコード読取 → 参加者情報表示 → 支払い調整 → チェックイン更新</p>
    </header>

    <div class="card" style="margin-top:12px;">
    <h2>API 設定</h2>
    <label for="api-url-input" class="small">SheetToREST の URL（?action を除いた基本URL）</label>
    <input id="api-url-input" placeholder="例: https://script.google.com/macros/s/XXXXX/exec" />
    <button id="save-api-btn">API URL を設定</button>
    <div id="api-status" class="small"></div>
    </div>

    <div class="layout">
      <div class="left">
        <div class="card">
          <h2>1. QRコードを読み取る</h2>
          <div id="qr-reader"></div>
          <div class="status" id="scan-status">
            カメラに参加者のQRコードをかざしてください。
          </div>
        </div>
      </div>

      <div class="right">
        <div class="card">
          <h2>2. 参加者情報</h2>
          <div id="participant-info">
            <div class="small">まだ参加者が読み込まれていません。</div>
          </div>

          <h2 style="margin-top: 16px;">3. 支払い・枠調整</h2>
          <div id="payment-panel" class="payment-panel payment-green">
            <div class="small">参加者を読み込むとここに表示されます。</div>
          </div>

          <div class="select-row" style="margin-top: 8px;">
            <label for="adjustment-type">枠変更 / 学割 / その他調整</label>
            <select id="adjustment-type">
              <option value="default">デフォルト（変更なし）</option>
              <option value="general_to_bring">一般 → 持参（-1000円）</option>
              <option value="bring_to_general">持参 → 一般（+1000円）</option>
              <option value="student_general">学割（一般）（-3000円）</option>
              <option value="student_bring">学割（持参）（-2000円）</option>
              <option value="other">その他（任意の増減）</option>
            </select>
          </div>

          <div id="other-adjustment-area" style="display:none; margin-top: 6px;">
            <div class="select-row">
              <label for="other-amount">その他：増減する金額（例: 1000 か -1000）</label>
              <input type="number" id="other-amount" placeholder="例: 1000 なら追加徴収 / -1000 ならキャッシュバック" />
            </div>
            <div class="select-row">
              <label for="other-reason">その他：理由（必須）</label>
              <textarea id="other-reason" placeholder="例: 受付時に枠種を変更 / 特別割引 等"></textarea>
            </div>
          </div>

          <div class="select-row" style="margin-top: 6px;">
            <label for="note-extra">編集メモ（任意・editnotesに追記されます）</label>
            <textarea id="note-extra" placeholder="受付担当者の名前や一言メモなど"></textarea>
          </div>

          <button id="submit-btn" disabled>チェックイン完了として登録</button>
          <div class="small">
            ※ チェックイン完了時に <code>ischeckin=TRUE</code> に更新し、調整内容は <code>editnotes</code> に追記されます。
          </div>
          <div class="log" id="log-area"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === 設定値（ここだけ必ずあなたの環境に合わせて変更） =======================
    // SheetToREST の Web アプリ URL（?action=one&id=... で1件取得できるエンドポイント）
    let API_BASE_URL = "";
    // もしセキュリティ用トークンを実装しているなら、ここにクエリを追加する:
    // 例: const API_EXTRA_QUERY = "&api_token=YOUR_TOKEN";
    const API_EXTRA_QUERY = "";
    // =====================================================================

    // グローバル状態（ブラウザ内のみ）
    let currentParticipantId = null;
    let currentRecord = null;
    let lastDecodedText = null;

    const scanStatusEl = document.getElementById("scan-status");
    const participantInfoEl = document.getElementById("participant-info");
    const paymentPanelEl = document.getElementById("payment-panel");
    const adjustmentTypeEl = document.getElementById("adjustment-type");
    const otherAreaEl = document.getElementById("other-adjustment-area");
    const otherAmountEl = document.getElementById("other-amount");
    const otherReasonEl = document.getElementById("other-reason");
    const noteExtraEl = document.getElementById("note-extra");
    const submitBtn = document.getElementById("submit-btn");
    const logArea = document.getElementById("log-area");
    const apiInput = document.getElementById("api-url-input");
    const saveApiBtn = document.getElementById("save-api-btn");
    const apiStatus = document.getElementById("api-status");

saveApiBtn.addEventListener("click", () => {
  const url = apiInput.value.trim();
  API_BASE_URL = url;
  localStorage.setItem("api_url", url);
  apiStatus.textContent = "API URL を保存しました。";
});

// 初回ロード時
window.addEventListener("load", () => {
  const saved = localStorage.getItem("api_url");
  if (saved) {
    API_BASE_URL = saved;
    apiInput.value = saved;
    apiStatus.textContent = "保存された API URL を読み込みました。";
  }
});


    function log(message) {
      const now = new Date().toLocaleTimeString();
      logArea.textContent = `[${now}] ${message}\n` + logArea.textContent;
    }

    function extractParticipantIdFromUrl(urlText) {
      try {
        const match = urlText.match(/participant\/(\d+)\//);
        if (match && match[1]) {
          return match[1];
        }
      } catch (e) {
        // ignore
      }
      return null;
    }

    function parseIntSafe(value) {
      if (value === null || value === undefined) return 0;
      const n = parseInt(String(value).replace(/[^0-9\-]/g, ""), 10);
      return isNaN(n) ? 0 : n;
    }

    function updateParticipantInfoUI(record) {
      if (!record) {
        participantInfoEl.innerHTML = '<div class="small">データが取得できませんでした。</div>';
        return;
      }

      const gamerTag = record["GamerTag"] || "(不明)";
      const venueType = record["Venue Type"] || "";
      const adminNotes = record["Admin Notes"] || "";
      const checkedInRaw = record["Checked In"] || record["ischeckin"] || "";
      const totalOwed = parseIntSafe(record["Total Owed"]);
      const totalTransaction = parseIntSafe(record["Total Transaction"]);
      const balance = parseIntSafe(record["Balance"]);

      const checkedInLabel =
        (String(checkedInRaw).toUpperCase() === "TRUE" || checkedInRaw === "1")
          ? '<span class="badge" style="border-color:#3cb371;color:#9cffc5;">CHECKED-IN</span>'
          : '<span class="badge" style="border-color:#ff6347;color:#ffc4b5;">NOT CHECKED-IN</span>';

      // 対戦台番号の簡易抽出：Admin Notes 内に「台XX」形式がある想定（なければ空）
      let stationText = "";
      const stationMatch = adminNotes.match(/台\s*([A-Za-z0-9\-]+)/);
      if (stationMatch && stationMatch[1]) {
        stationText = stationMatch[1];
      }

      const html = `
        <div class="field-row highlight">
          <div class="field-label">参加者ID</div>
          <div class="field-value">
            ${currentParticipantId || "-"} ${checkedInLabel}
          </div>
        </div>
        <div class="field-row">
          <div class="field-label">GamerTag</div>
          <div class="field-value">${gamerTag}</div>
        </div>
        <div class="field-row">
          <div class="field-label">枠種</div>
          <div class="field-value">${venueType || "(未設定)"}</div>
        </div>
        <div class="field-row">
          <div class="field-label">Total Owed</div>
          <div class="field-value">${totalOwed} 円</div>
        </div>
        <div class="field-row">
          <div class="field-label">Total Transaction</div>
          <div class="field-value">${totalTransaction} 円</div>
        </div>
        <div class="field-row">
          <div class="field-label">Balance</div>
          <div class="field-value">${balance} 円</div>
        </div>
        <div class="field-row">
          <div class="field-label">対戦台番号</div>
          <div class="field-value">${stationText || "(Admin Notes参照)"}</div>
        </div>
        <div class="field-row">
          <div class="field-label">Admin Notes</div>
          <div class="field-value">${adminNotes || "(なし)"}</div>
        </div>
      `;

      participantInfoEl.innerHTML = html;
    }

    function computePaymentAndUpdateUI() {
      if (!currentRecord) {
        paymentPanelEl.className = "payment-panel payment-green";
        paymentPanelEl.innerHTML =
          '<div class="small">参加者を読み込むとここに支払い情報が表示されます。</div>';
        return;
      }

      const totalOwed = parseIntSafe(currentRecord["Total Owed"]);
      const totalTransaction = parseIntSafe(currentRecord["Total Transaction"]);

      let baseAmount = 0;
      let baseLabel = "";
      if (totalTransaction === 0) {
        baseAmount = totalOwed;
        baseLabel = "事前決済なし → Total Owed が基本額";
      } else {
        baseAmount = 0;
        baseLabel = "Total Transaction が 0 以外 → 事前決済済み";
      }

      const adjustmentType = adjustmentTypeEl.value;
      const adjustmentLabels = {
        default: "デフォルト（変更なし）",
        general_to_bring: "一般 → 持参（-1000円）",
        bring_to_general: "持参 → 一般（+1000円）",
        student_general: "学割（一般）（-3000円）",
        student_bring: "学割（持参）（-2000円）",
        other: "その他（任意の増減）"
      };

      let delta = 0;
      let deltaLabel = "";

      switch (adjustmentType) {
        case "general_to_bring":
          delta = -1000;
          break;
        case "bring_to_general":
          delta = +1000;
          break;
        case "student_general":
          delta = -3000;
          break;
        case "student_bring":
          delta = -2000;
          break;
        case "other":
          delta = parseIntSafe(otherAmountEl.value);
          break;
        default:
          delta = 0;
      }

      deltaLabel = adjustmentLabels[adjustmentType] || "";

      const finalAmount = baseAmount + delta;

      let panelClass = "payment-panel payment-green";
      let statusLine = "";
      if (finalAmount > 0) {
        panelClass = "payment-panel payment-red";
        statusLine = `<span class="danger-text"><strong>要支払い：${finalAmount} 円</strong></span>`;
      } else if (finalAmount < 0) {
        panelClass = "payment-panel payment-green";
        statusLine = `<span class="success-text"><strong>キャッシュバック：${Math.abs(finalAmount)} 円</strong></span>`;
      } else {
        panelClass = "payment-panel payment-green";
        statusLine = `<span class="success-text"><strong>支払い・キャッシュバックともに 0 円</strong></span>`;
      }

      paymentPanelEl.className = panelClass;
      paymentPanelEl.innerHTML = `
        <div class="payment-row">
          <div>基本額</div>
          <div><strong>${baseAmount} 円</strong></div>
        </div>
        <div class="payment-row">
          <div>調整額</div>
          <div><strong>${delta >= 0 ? "+" + delta : delta} 円</strong></div>
        </div>
        <div class="payment-row">
          <div>最終的な支払額（+）/ キャッシュバック額（-）</div>
          <div><strong>${finalAmount} 円</strong></div>
        </div>
        <div style="margin-top:4px;" class="small">
          ${statusLine}<br/>
          <span>基本額の根拠：${baseLabel}</span><br/>
          <span>調整内容：${deltaLabel}</span>
        </div>
      `;
    }

    adjustmentTypeEl.addEventListener("change", () => {
      const type = adjustmentTypeEl.value;
      if (type === "other") {
        otherAreaEl.style.display = "block";
      } else {
        otherAreaEl.style.display = "none";
      }
      computePaymentAndUpdateUI();
    });

    otherAmountEl.addEventListener("input", computePaymentAndUpdateUI);

    async function fetchParticipant(id) {
      if (!API_BASE_URL) {
      alert("API URL が設定されていません。上部の API 設定欄から入力してください。");
      return;
      }
      currentParticipantId = id;
      currentRecord = null;
      submitBtn.disabled = true;
      scanStatusEl.textContent = `参加者ID ${id} を検索中...`;

      try {
        const url = `${API_BASE_URL}?action=one&id=${encodeURIComponent(id)}${API_EXTRA_QUERY}`;
        log(`GET ${url}`);
        const res = await fetch(url, { method: "GET" });

        if (!res.ok) {
          throw new Error(`HTTP error ${res.status}`);
        }

        const data = await res.json();

        if (data && data.error) {
          participantInfoEl.innerHTML =
            `<div class="danger-text">エラー：${data.error}（シートに該当IDがない可能性）</div>`;
          paymentPanelEl.className = "payment-panel payment-green";
          paymentPanelEl.innerHTML = '<div class="small">参加者情報が取得できなかったため、支払い計算は行いません。</div>';
          scanStatusEl.textContent = "QRを再度読み取ってください。";
          log(`Error from API: ${JSON.stringify(data)}`);
          return;
        }

        currentRecord = data;
        updateParticipantInfoUI(currentRecord);
        computePaymentAndUpdateUI();
        submitBtn.disabled = false;
        scanStatusEl.textContent = `参加者ID ${id} の情報を取得しました。`;
        log(`Participant loaded: ${id}`);
      } catch (err) {
        console.error(err);
        participantInfoEl.innerHTML =
          `<div class="danger-text">参加者データ取得に失敗しました。ネットワークやAPI設定を確認してください。</div>`;
        paymentPanelEl.className = "payment-panel payment-green";
        paymentPanelEl.innerHTML = '<div class="small">参加者情報が取得できなかったため、支払い計算は行いません。</div>';
        scanStatusEl.textContent = "エラーが発生しました。ログを確認してください。";
        log(`Fetch error: ${err.message}`);
      }
    }

    function buildEditNotesAppendText(finalAmount, delta) {
      const now = new Date();
      const ts = now.getFullYear() + "-" +
        String(now.getMonth() + 1).padStart(2, "0") + "-" +
        String(now.getDate()).padStart(2, "0") + " " +
        String(now.getHours()).padStart(2, "0") + ":" +
        String(now.getMinutes()).padStart(2, "0");

      const adjustmentType = adjustmentTypeEl.value;
      const labels = {
        default: "デフォルト（変更なし）",
        general_to_bring: "一般 → 持参（-1000円）",
        bring_to_general: "持参 → 一般（+1000円）",
        student_general: "学割（一般）（-3000円）",
        student_bring: "学割（持参）（-2000円）",
        other: "その他調整"
      };

      let extraReason = noteExtraEl.value.trim();
      if (adjustmentType === "other") {
        const otherReason = otherReasonEl.value.trim();
        if (otherReason) {
          extraReason = extraReason ? `${extraReason} / ${otherReason}` : otherReason;
        }
      }

      const label = labels[adjustmentType] || "不明な調整";
      const deltaText = delta >= 0 ? `+${delta}` : `${delta}`;

      let note = `[${ts}] 調整:${label} 調整額:${deltaText} 最終支払額:${finalAmount}`;
      if (extraReason) {
        note += ` 備考:${extraReason}`;
      }
      return note;
    }

    submitBtn.addEventListener("click", async () => {
      if (!API_BASE_URL) {
        alert("API URL が設定されていません。上部で設定してください。");
        return;
      }
      if (!currentParticipantId || !currentRecord) {
        alert("参加者が読み込まれていません。先にQRコードを読み取ってください。");
        return;
      }

      const totalOwed = parseIntSafe(currentRecord["Total Owed"]);
      const totalTransaction = parseIntSafe(currentRecord["Total Transaction"]);

      let baseAmount = 0;
      if (totalTransaction === 0) {
        baseAmount = totalOwed;
      } else {
        baseAmount = 0;
      }

      const adjustmentType = adjustmentTypeEl.value;
      let delta = 0;

      switch (adjustmentType) {
        case "general_to_bring":
          delta = -1000;
          break;
        case "bring_to_general":
          delta = +1000;
          break;
        case "student_general":
          delta = -3000;
          break;
        case "student_bring":
          delta = -2000;
          break;
        case "other":
          delta = parseIntSafe(otherAmountEl.value);
          if (!otherAmountEl.value) {
            alert("その他調整の場合、増減する金額を入力してください。");
            return;
          }
          if (!otherReasonEl.value.trim()) {
            alert("その他調整の場合、理由の入力をお願いします。");
            return;
          }
          break;
        default:
          delta = 0;
      }

      const finalAmount = baseAmount + delta;

      const confirmMessage =
        `参加者ID: ${currentParticipantId}\n` +
        `GamerTag: ${currentRecord["GamerTag"] || "(不明)"}\n\n` +
        `基本額: ${baseAmount} 円\n` +
        `調整額: ${delta >= 0 ? "+" + delta : delta} 円\n` +
        `最終的な支払額: ${finalAmount} 円\n\n` +
        `ischeckin を TRUE に更新し、editnotes に調整内容を追記してよろしいですか？`;

      if (!window.confirm(confirmMessage)) {
        return;
      }

      submitBtn.disabled = true;

      try {
        const existingEditNotes = currentRecord["editnotes"] || "";
        const appendText = buildEditNotesAppendText(finalAmount, delta);
        const newEditNotes = existingEditNotes
          ? `${existingEditNotes}\n${appendText}`
          : appendText;

        const payload = {
          ischeckin: true,
          editnotes: newEditNotes
        };

        const url = `${API_BASE_URL}?action=update&id=${encodeURIComponent(currentParticipantId)}${API_EXTRA_QUERY}`;
        log(`POST ${url} payload=${JSON.stringify(payload)}`);

        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error(`HTTP error ${res.status}`);
        }

        const data = await res.json();
        if (data && data.error) {
          throw new Error(`API error: ${data.error}`);
        }

        log(`Update success: ${JSON.stringify(data)}`);
        alert("チェックイン情報を更新しました。");

        // ローカル状態も更新して表示をリフレッシュ
        currentRecord["ischeckin"] = "TRUE";
        currentRecord["editnotes"] = newEditNotes;
        updateParticipantInfoUI(currentRecord);
        computePaymentAndUpdateUI();
      } catch (err) {
        console.error(err);
        log(`Update failed: ${err.message}`);
        alert("更新に失敗しました。ネットワークやAPI設定を確認してください。");
      } finally {
        submitBtn.disabled = false;
      }
    });

    // === QRコードスキャナのセットアップ ===========================================
    function onScanSuccess(decodedText, decodedResult) {
      if (decodedText === lastDecodedText) {
        // 連続で同じコードが来るので無視
        return;
      }
      lastDecodedText = decodedText;

      log(`QR decoded: ${decodedText}`);

      const id = extractParticipantIdFromUrl(decodedText);
      if (!id) {
        scanStatusEl.textContent = "QRコードから参加者IDを抽出できませんでした。";
        log("Could not extract participant id from QR.");
        return;
      }

      fetchParticipant(id);
    }

    function onScanFailure(error) {
      // デバッグしたい場合だけログする。毎フレーム呼ばれるので黙っておく方が無難。
      // log(`Scan failure: ${error}`);
    }

    function initScanner() {
      const config = {
        fps: 10,
        qrbox: {
          width: 240,
          height: 240
        },
        aspectRatio: 1.0
      };

      const verbose = false;
      const scanner = new Html5QrcodeScanner("qr-reader", config, verbose);
      scanner.render(onScanSuccess, onScanFailure);
    }

    window.addEventListener("load", initScanner);
  </script>
</body>
</html>
